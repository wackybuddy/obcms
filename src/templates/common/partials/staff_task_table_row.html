{% load task_tags %}
<tr
    class="group relative hover:bg-slate-50/30 transition-colors border-b border-slate-100"
    data-task-id="{{ task.id }}"
>
    <!-- Task Title Cell -->
    <td class="px-5 py-3 border-r border-slate-100 min-w-[13rem]">
        <div class="flex items-start gap-2.5">
            <span class="w-2.5 h-2.5 mt-0.5 rounded-full
                {% if task.status == 'completed' %}bg-emerald-500
                {% elif task.status == 'in_progress' %}bg-blue-500
                {% elif task.status == 'at_risk' %}bg-rose-500
                {% elif task.status == 'not_started' %}bg-amber-400
                {% else %}bg-slate-300{% endif %}"></span>
            <div
                class="flex-1 min-h-[38px] flex items-center px-3 py-2 rounded-md hover:bg-slate-100 cursor-text text-sm leading-snug"
                contenteditable="true"
                data-field="title"
                data-task-id="{{ task.id }}"
                data-original-value="{{ task.title }}"
            >{{ task.title }}</div>
        </div>
    </td>

    <!-- Assignee Cell -->
    <td class="px-4 py-3 border-r border-slate-100 min-w-[10rem]">
        <div
            class="min-h-[38px] flex items-center px-2.5 py-1.5 rounded-md hover:bg-slate-100 cursor-pointer text-sm"
            data-field="assignees"
            data-task-id="{{ task.id }}"
            data-original-value="{{ assignee_ids|join:',' }}"
            data-display-value="{{ assignee_display }}"
        >
            {% if assignees %}
                <div class="flex flex-wrap gap-1">
                    {% for member in assignees %}
                        <span class="inline-flex items-center px-1.5 py-0.5 rounded-full bg-blue-50 text-blue-700 text-xs font-medium">
                            {{ member.label }}
                        </span>
                    {% endfor %}
                </div>
            {% else %}
                <span class="text-slate-400">Unassigned</span>
            {% endif %}
        </div>
    </td>

    <!-- Teams Cell -->
    <td class="px-4 py-3 border-r border-slate-100 min-w-[9rem]">
        <div
            class="min-h-[38px] flex items-center px-2.5 py-1.5 rounded-md hover:bg-slate-100 cursor-pointer text-sm"
            data-field="teams"
            data-task-id="{{ task.id }}"
            data-original-value="{% for team in task.teams.all %}{{ team.id }}{% if not forloop.last %},{% endif %}{% endfor %}"
            data-display-value="{% for team in task.teams.all %}{{ team.name }}{% if not forloop.last %}, {% endif %}{% empty %}No teams{% endfor %}"
        >
            {% if task.teams.all %}
                <div class="flex flex-wrap gap-1">
                    {% for team in task.teams.all %}
                        <span class="inline-flex items-center px-1.5 py-0.5 rounded-md text-xs bg-blue-50 text-blue-700">
                            {{ team.name }}
                        </span>
                    {% endfor %}
                </div>
            {% else %}
                <span class="text-slate-400">No teams</span>
            {% endif %}
        </div>
    </td>

    <!-- Start Date Cell -->
    <td class="px-4 py-2 border-r border-slate-100">
        <div
            class="min-h-[32px] flex items-center px-2 py-1 rounded hover:bg-slate-100 cursor-pointer text-sm"
            data-field="start_date"
            data-task-id="{{ task.id }}"
            data-original-value="{{ task.start_date|date:'Y-m-d'|default:'' }}"
        >
            {% if task.start_date %}
                <div>
                    <div class="font-medium">{{ task.start_date|date:"M j, Y" }}</div>
                    <div class="text-xs text-slate-500">Started {{ task.start_date|timesince }} ago</div>
                </div>
            {% else %}
                <span class="text-slate-400">No start date</span>
            {% endif %}
        </div>
    </td>

    <!-- Due Date Cell -->
    <td class="px-4 py-2 border-r border-slate-100">
        <div
            class="min-h-[32px] flex items-center px-2 py-1 rounded hover:bg-slate-100 cursor-pointer text-sm"
            data-field="due_date"
            data-task-id="{{ task.id }}"
            data-original-value="{{ task.due_date|date:'Y-m-d'|default:'' }}"
        >
            {% if task.due_date %}
                <div>
                    <div class="font-medium">{{ task.due_date|date:"M j, Y" }}</div>
                    <div class="text-xs text-slate-500">Due {{ task.due_date|timeuntil }}</div>
                </div>
            {% else %}
                <span class="text-slate-400">No due date</span>
            {% endif %}
        </div>
    </td>

    <!-- Status Cell -->
    <td class="px-2 py-2 border-r border-slate-100">
        <div
            class="min-h-[32px] flex items-center px-1 py-1 rounded hover:bg-slate-100 cursor-pointer text-sm"
            data-field="status"
            data-task-id="{{ task.id }}"
            data-original-value="{{ task.status }}"
        >
            {% if task.status == 'completed' %}
                <span class="inline-flex items-center px-1.5 py-0.5 rounded-md text-xs bg-green-50 text-green-700">Completed</span>
            {% elif task.status == 'in_progress' %}
                <span class="inline-flex items-center px-1.5 py-0.5 rounded-md text-xs bg-blue-50 text-blue-700">In Progress</span>
            {% elif task.status == 'at_risk' %}
                <span class="inline-flex items-center px-1.5 py-0.5 rounded-md text-xs bg-red-50 text-red-700">At Risk</span>
            {% else %}
                <span class="inline-flex items-center px-1.5 py-0.5 rounded-md text-xs bg-gray-50 text-gray-700">Not Started</span>
            {% endif %}
        </div>
    </td>

    <!-- Priority Cell -->
    <td class="px-2 py-2 border-r border-slate-100 min-w-[5rem] w-[5rem]">
        <div
            class="min-h-[32px] flex items-center px-1 py-1 rounded hover:bg-slate-100 cursor-pointer text-sm"
            data-field="priority"
            data-task-id="{{ task.id }}"
            data-original-value="{{ task.priority }}"
        >
            {% if task.priority == 'critical' %}
                <span class="inline-flex items-center px-1.5 py-0.5 rounded-md text-xs bg-red-50 text-red-700">Critical</span>
            {% elif task.priority == 'high' %}
                <span class="inline-flex items-center px-1.5 py-0.5 rounded-md text-xs bg-orange-50 text-orange-700">High</span>
            {% elif task.priority == 'medium' %}
                <span class="inline-flex items-center px-1.5 py-0.5 rounded-md text-xs bg-blue-50 text-blue-700">Medium</span>
            {% else %}
                <span class="inline-flex items-center px-1.5 py-0.5 rounded-md text-xs bg-gray-50 text-gray-700">Low</span>
            {% endif %}
        </div>
    </td>

    <!-- Progress Cell -->
    <td class="px-4 py-2 border-r border-slate-100">
        <div class="min-h-[32px] flex items-center px-2 py-1 rounded hover:bg-slate-100 cursor-pointer text-sm">
            <div class="flex items-center gap-2 w-full">
                <div class="flex-1 h-2 bg-slate-200 rounded-full overflow-hidden">
                    <div
                        class="h-full bg-emerald-500 transition-all duration-300"
                        style="width: {{ task.progress }}%"
                    ></div>
                </div>
                <span
                    class="text-xs font-medium text-slate-600 min-w-[30px]"
                    contenteditable="true"
                    data-field="progress"
                    data-task-id="{{ task.id }}"
                    data-original-value="{{ task.progress }}"
                >{{ task.progress }}%</span>
            </div>
        </div>
    </td>

    <!-- Actions Cell -->
    <td class="px-4 py-2">
        <div class="flex flex-wrap gap-2">
            {% task_action_url task 'detail' as task_detail_url %}
            <a href="{{ task_detail_url }}"
               class="bg-white border border-blue-200 text-blue-600 hover:bg-blue-50 px-3 py-1 rounded text-xs font-medium transition-colors duration-200"
               data-modal-link
               title="View task details">
                <i class="fas fa-eye mr-1"></i>
                View
            </a>
            {% task_action_url task 'edit' as task_edit_url %}
            <a href="{{ task_edit_url }}"
               class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs font-medium transition-colors duration-200"
               data-modal-link
               title="Edit task">
                <i class="fas fa-edit mr-1"></i>
                Edit
            </a>
            <button type="button"
                    class="inline-flex items-center justify-center bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs font-medium transition-colors duration-200"
                    data-delete-task="{{ task.id }}"
                    data-confirm="Are you sure you want to delete this task? This action cannot be undone."
                    title="Delete task">
                <i class="fas fa-trash-alt"></i>
                <span class="sr-only">Delete</span>
            </button>
            <div class="w-4 h-4 hidden" id="saving-{{ task.id }}">
                <i class="fas fa-spinner fa-spin text-xs text-emerald-600"></i>
            </div>
        </div>
    </td>
</tr>
