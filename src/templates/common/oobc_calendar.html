{% extends "base.html" %}
{% load static %}

{% block title %}OOBC Calendar{% endblock %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'common/css/calendar-enhanced.css' %}">
{% endblock %}

{% block breadcrumb %}
<li><a href="{% url 'common:dashboard' %}" class="text-neutral-500 hover:text-neutral-700">Dashboard</a></li>
<li><span class="text-neutral-400 mx-1">/</span></li>
<li><a href="{% url 'common:oobc_management_home' %}" class="text-neutral-500 hover:text-neutral-700">OOBC Management</a></li>
<li><span class="text-neutral-400 mx-1">/</span></li>
<li class="text-neutral-800 font-semibold">Calendar</li>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-8">

    {# Hero Section #}
    <section class="relative overflow-hidden rounded-3xl bg-gradient-to-r from-blue-600 via-indigo-500 to-purple-600 shadow-2xl">
        <div class="absolute inset-0 bg-white/10 opacity-20 mix-blend-overlay"></div>
        <div class="absolute top-0 right-0 w-96 h-96 bg-white/10 rounded-full -mr-48 -mt-48"></div>

        <div class="relative px-6 sm:px-10 py-8 sm:py-10">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-8">
                <div class="flex-1 space-y-4">
                    <div class="inline-flex items-center rounded-lg bg-white/20 backdrop-blur-sm px-3 py-1.5 text-sm font-semibold text-white border border-white/30">
                        <i class="fas fa-calendar-alt mr-2"></i>
                        ORGANIZATION CALENDAR
                    </div>

                    <h1 class="text-3xl sm:text-4xl font-bold text-white leading-tight">
                        OOBC Calendar
                    </h1>

                    <p class="text-white/90 text-base sm:text-lg max-w-2xl leading-relaxed">
                        {% if USE_UNIFIED_CALENDAR %}
                        View hierarchical work items across Projects, Activities, and Tasks in a unified calendar view
                        {% else %}
                        View and manage all tasks, events, and activities in one centralized calendar
                        {% endif %}
                    </p>
                </div>

                <div class="flex-shrink-0">
                    <div class="flex flex-col gap-3 min-w-[220px]">
                        <a href="{% url 'common:work_item_create' %}" class="flex items-center justify-center gap-2 px-5 py-3 rounded-xl bg-white text-purple-600 font-semibold shadow-lg hover:bg-purple-50 hover:shadow-xl transition-all duration-200">
                            <i class="fas fa-plus-circle"></i>
                            <span>Create Work Item</span>
                        </a>
                        <a href="{% url 'common:work_item_list' %}" class="flex items-center justify-center gap-2 px-5 py-3 rounded-xl bg-white/20 backdrop-blur-sm text-white font-semibold border border-white/30 hover:bg-white/30 transition-all duration-200">
                            <i class="fas fa-th-list"></i>
                            <span>List View</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </section>

    {# Statistics Cards - 3D Milk White Design #}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Total Work Items -->
        <div class="relative overflow-hidden bg-gradient-to-br from-[#FEFDFB] to-[#FBF9F5] rounded-2xl transform hover:-translate-y-2 transition-all duration-300"
             style="box-shadow: 0 8px 20px rgba(0,0,0,0.08), 0 2px 8px rgba(0,0,0,0.06), inset 0 -2px 4px rgba(0,0,0,0.02), inset 0 2px 4px rgba(255,255,255,0.9);">
            <div class="absolute inset-0 bg-gradient-to-br from-white/60 via-transparent to-gray-100/20"></div>
            <div class="relative p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm font-semibold uppercase tracking-wide">Total Work Items</p>
                        <p class="text-4xl font-extrabold text-gray-800 mt-1" id="stat-total-items">0</p>
                    </div>
                    <div class="w-16 h-16 rounded-2xl flex items-center justify-center"
                         style="background: linear-gradient(135deg, #FFFFFF 0%, #F5F3F0 100%); box-shadow: 0 4px 12px rgba(0,0,0,0.1), inset 0 -2px 4px rgba(0,0,0,0.05), inset 0 2px 4px rgba(255,255,255,0.8);">
                        <i class="fas fa-tasks text-2xl text-amber-600"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upcoming Events -->
        <div class="relative overflow-hidden bg-gradient-to-br from-[#FEFDFB] to-[#FBF9F5] rounded-2xl transform hover:-translate-y-2 transition-all duration-300"
             style="box-shadow: 0 8px 20px rgba(0,0,0,0.08), 0 2px 8px rgba(0,0,0,0.06), inset 0 -2px 4px rgba(0,0,0,0.02), inset 0 2px 4px rgba(255,255,255,0.9);">
            <div class="absolute inset-0 bg-gradient-to-br from-white/60 via-transparent to-gray-100/20"></div>
            <div class="relative p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm font-semibold uppercase tracking-wide">Upcoming Events</p>
                        <p class="text-4xl font-extrabold text-gray-800 mt-1" id="stat-upcoming">0</p>
                    </div>
                    <div class="w-16 h-16 rounded-2xl flex items-center justify-center"
                         style="background: linear-gradient(135deg, #FFFFFF 0%, #F5F3F0 100%); box-shadow: 0 4px 12px rgba(0,0,0,0.1), inset 0 -2px 4px rgba(0,0,0,0.05), inset 0 2px 4px rgba(255,255,255,0.8);">
                        <i class="fas fa-calendar-day text-2xl text-blue-600"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- In Progress -->
        <div class="relative overflow-hidden bg-gradient-to-br from-[#FEFDFB] to-[#FBF9F5] rounded-2xl transform hover:-translate-y-2 transition-all duration-300"
             style="box-shadow: 0 8px 20px rgba(0,0,0,0.08), 0 2px 8px rgba(0,0,0,0.06), inset 0 -2px 4px rgba(0,0,0,0.02), inset 0 2px 4px rgba(255,255,255,0.9);">
            <div class="absolute inset-0 bg-gradient-to-br from-white/60 via-transparent to-gray-100/20"></div>
            <div class="relative p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm font-semibold uppercase tracking-wide">In Progress</p>
                        <p class="text-4xl font-extrabold text-gray-800 mt-1" id="stat-in-progress">0</p>
                    </div>
                    <div class="w-16 h-16 rounded-2xl flex items-center justify-center"
                         style="background: linear-gradient(135deg, #FFFFFF 0%, #F5F3F0 100%); box-shadow: 0 4px 12px rgba(0,0,0,0.1), inset 0 -2px 4px rgba(0,0,0,0.05), inset 0 2px 4px rgba(255,255,255,0.8);">
                        <i class="fas fa-spinner text-2xl text-purple-600"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Completed -->
        <div class="relative overflow-hidden bg-gradient-to-br from-[#FEFDFB] to-[#FBF9F5] rounded-2xl transform hover:-translate-y-2 transition-all duration-300"
             style="box-shadow: 0 8px 20px rgba(0,0,0,0.08), 0 2px 8px rgba(0,0,0,0.06), inset 0 -2px 4px rgba(0,0,0,0.02), inset 0 2px 4px rgba(255,255,255,0.9);">
            <div class="absolute inset-0 bg-gradient-to-br from-white/60 via-transparent to-gray-100/20"></div>
            <div class="relative p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm font-semibold uppercase tracking-wide">Completed</p>
                        <p class="text-4xl font-extrabold text-gray-800 mt-1" id="stat-completed">0</p>
                    </div>
                    <div class="w-16 h-16 rounded-2xl flex items-center justify-center"
                         style="background: linear-gradient(135deg, #FFFFFF 0%, #F5F3F0 100%); box-shadow: 0 4px 12px rgba(0,0,0,0.1), inset 0 -2px 4px rgba(0,0,0,0.05), inset 0 2px 4px rgba(255,255,255,0.8);">
                        <i class="fas fa-check-circle text-2xl text-emerald-600"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Type Filters (only for unified calendar) #}
    {% if USE_UNIFIED_CALENDAR %}
    <div class="bg-white rounded-xl shadow-md border border-gray-200 p-4">
        <div class="flex flex-wrap items-center gap-4">
            <div class="flex items-center gap-2 text-sm font-medium text-gray-700">
                <i class="fas fa-filter text-gray-400"></i>
                <span>Show:</span>
            </div>
            <label class="inline-flex items-center gap-2 cursor-pointer px-3 py-2 rounded-lg hover:bg-gray-50 transition-colors">
                <input type="checkbox" checked data-filter="project" class="rounded text-blue-600 focus:ring-blue-500">
                <i class="fas fa-project-diagram text-blue-600"></i>
                <span class="text-gray-700 font-medium">Projects</span>
            </label>
            <label class="inline-flex items-center gap-2 cursor-pointer px-3 py-2 rounded-lg hover:bg-gray-50 transition-colors">
                <input type="checkbox" checked data-filter="activity" class="rounded text-emerald-600 focus:ring-emerald-500">
                <i class="fas fa-clipboard-list text-emerald-600"></i>
                <span class="text-gray-700 font-medium">Activities</span>
            </label>
            <label class="inline-flex items-center gap-2 cursor-pointer px-3 py-2 rounded-lg hover:bg-gray-50 transition-colors">
                <input type="checkbox" checked data-filter="task" class="rounded text-purple-600 focus:ring-purple-500">
                <i class="fas fa-check-square text-purple-600"></i>
                <span class="text-gray-700 font-medium">Tasks</span>
            </label>
            <div class="ml-auto">
                <label class="inline-flex items-center gap-2 cursor-pointer px-3 py-2 rounded-lg hover:bg-gray-50 transition-colors">
                    <input type="checkbox" data-filter="completed" class="rounded text-gray-600 focus:ring-gray-500">
                    <i class="fas fa-eye text-gray-600"></i>
                    <span class="text-gray-700 font-medium">Show Completed</span>
                </label>
            </div>
        </div>
    </div>
    {% endif %}

    {# Calendar Container #}
    <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-6">
        <div id="calendar"></div>
    </div>

</div>

{# Simple Modal for Event/Task Details #}
<div id="eventModal" class="hidden fixed inset-0 z-50 flex items-center justify-center px-4 bg-gray-900 bg-opacity-50">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div id="modalContent" class="p-6">
            {# Content loaded via fetch #}
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
{{ block.super }}

{# FullCalendar #}
<script src="{% static 'common/vendor/fullcalendar/index.global.min.js' %}"></script>

<script>
(function() {
    'use strict';

    // ============================================
    // SIMPLE CALENDAR IMPLEMENTATION
    // ============================================

    var calendarEl = document.getElementById('calendar');
    var modal = document.getElementById('eventModal');
    var modalContent = document.getElementById('modalContent');

    // Initialize FullCalendar
    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,listWeek'
        },
        height: 'auto',

        // Event overflow handling (Google Calendar pattern)
        dayMaxEvents: 4,  // Show max 4 events per day
        moreLinkClick: 'popover',  // Show "+N more" in popover

        // Compact view settings
        eventDisplay: 'block',
        displayEventTime: true,
        displayEventEnd: false,
        {% if USE_UNIFIED_CALENDAR %}
        events: function(info, successCallback, failureCallback) {
            fetch('{% url "common:work_items_calendar_feed" %}?start=' + info.startStr + '&end=' + info.endStr)
                .then(response => {
                    console.log('ðŸ“¡ Response status:', response.status, response.statusText);
                    if (!response.ok) {
                        throw new Error('HTTP error ' + response.status);
                    }
                    return response.text(); // Get as text first to debug
                })
                .then(text => {
                    console.log('ðŸ“„ Raw response:', text.substring(0, 200)); // Log first 200 chars
                    try {
                        const data = JSON.parse(text);
                        console.log('ðŸ“Š Parsed data:', Array.isArray(data) ? data.length + ' items' : typeof data);
                        if (Array.isArray(data)) {
                            console.log('âœ… Passing', data.length, 'events to calendar');
                            successCallback(data);
                        } else if (data && data.workItems && Array.isArray(data.workItems)) {
                            // Handle legacy format with workItems key
                            console.log('âœ… Passing', data.workItems.length, 'events from workItems key');
                            successCallback(data.workItems);
                        } else {
                            console.error('âŒ Data is not an array:', data);
                            failureCallback(new Error('Invalid data format'));
                        }
                    } catch (e) {
                        console.error('âŒ JSON parse error:', e);
                        failureCallback(e);
                    }
                })
                .catch(error => {
                    console.error('âŒ Fetch error:', error);
                    failureCallback(error);
                });
        },
        {% else %}
        events: '{% url "common:oobc_calendar_feed_json" %}',
        {% endif %}

        // When user clicks an event
        eventClick: function(info) {
            info.jsEvent.preventDefault();

            // Get the modal URL from event's URL property
            var modalUrl = info.event.url;
            if (!modalUrl) {
                console.error('No modal URL for event');
                return;
            }

            // Open modal and load content
            openModal(modalUrl);
        },

        // Styling
        eventClassNames: function(arg) {
            return ['rounded-lg', 'px-2', 'py-1'];
        },

        {% if USE_UNIFIED_CALENDAR %}
        // CRITICAL: Use eventContent for rendering (fires on every render, prevents duplication)
        // This callback defines what content should be displayed
        // Unlike eventDidMount, this fires on view switches and data updates
        eventContent: function(arg) {
            var viewType = arg.view.type || '';

            // List view: Let FullCalendar handle default rendering
            // We'll customize the icon in eventDidMount
            if (viewType.indexOf('list') !== -1) {
                return true; // Use default content rendering
            }

            // Month/Week views: Use custom compact layout
            var workItem = arg.event.extendedProps || {};
            var contentHTML = buildEventContentHTML(arg.event, workItem);

            return { html: contentHTML };
        },

        // Compact Google Calendar-style rendering
        // CRITICAL: eventDidMount is now only for SIDE EFFECTS (attributes, tooltips)
        // Content rendering moved to eventContent to prevent duplication on view switches
        eventDidMount: function(info) {
            var workItem = info.event.extendedProps || {};
            var workType = info.event.extendedProps.workType || '';
            var status = info.event.extendedProps.status || 'not_started';
            var priority = info.event.extendedProps.priority || 'medium';
            var level = workItem.level || 0;
            var originalTitle = info.event.title;

            // Add data attributes for CSS targeting
            info.el.setAttribute('data-work-type', workType);
            info.el.setAttribute('data-status', status);
            info.el.setAttribute('data-priority', priority);
            info.el.setAttribute('data-event-id', info.event.id);

            // Add hierarchy level class
            if (level > 0) {
                info.el.classList.add('hierarchy-level-' + level);
            }

            // CRITICAL: Custom rendering for list views - replace dot with work type icon
            var viewType = info.view.type || '';
            if (viewType.indexOf('list') !== -1) {
                // For list view, replace the colored dot with work type icon
                var graphicEl = info.el.querySelector('.fc-list-event-graphic');
                if (graphicEl && !graphicEl.hasAttribute('data-icon-set')) {
                    // Replace entire content with Font Awesome icon
                    var iconHtml = getWorkItemIconListView(workType);
                    graphicEl.innerHTML = iconHtml;
                    graphicEl.setAttribute('data-icon-set', 'true');

                    // Force compact styling immediately
                    graphicEl.style.padding = '4px';
                    graphicEl.style.width = '32px';
                    graphicEl.style.minWidth = '32px';
                    graphicEl.style.maxWidth = '32px';
                    graphicEl.style.textAlign = 'center';
                }

                // Apply styling to the title cell
                var titleCell = info.el.querySelector('.fc-list-event-title');
                if (titleCell) {
                    titleCell.style.paddingLeft = '4px';
                }
            }

            // Build comprehensive tooltip with all metadata
            var tooltipParts = [workType.replace('_', ' ').toUpperCase() + ': ' + originalTitle];
            if (status) tooltipParts.push('Status: ' + status.replace('_', ' '));
            if (priority && priority !== 'medium') tooltipParts.push('Priority: ' + priority);
            if (workItem.is_recurring || workItem.isRecurring) tooltipParts.push('Recurring event');
            if (workItem.project && workItem.project.name && workType !== 'project') {
                tooltipParts.push('Project: ' + workItem.project.name);
            }

            // Add time to tooltip if present
            var hasTime = workItem.start_time || (info.event.start && !info.event.allDay);
            if (hasTime) {
                var timeText = '';
                if (workItem.start_time) {
                    timeText = workItem.start_time;
                } else if (info.event.start && !info.event.allDay) {
                    timeText = info.event.start.toLocaleTimeString('en-US', {
                        hour: 'numeric',
                        minute: '2-digit'
                    });
                }
                if (timeText) {
                    tooltipParts.push('Time: ' + timeText);
                }
            }

            // Set title attribute for native browser tooltip
            info.el.setAttribute('title', tooltipParts.join('\n'));

            // Accessibility: Add comprehensive ARIA label
            info.el.setAttribute('aria-label', tooltipParts.join(', '));

            // Keyboard navigation support
            info.el.setAttribute('tabindex', '0');
            info.el.setAttribute('role', 'button');
        },

        // Breadcrumb tooltip on hover
        eventMouseEnter: function(info) {
            var breadcrumb = info.event.extendedProps.breadcrumb;
            if (breadcrumb) {
                var tooltip = document.createElement('div');
                tooltip.id = 'calendar-tooltip';
                tooltip.className = 'fixed z-50 bg-gray-900 text-white text-xs px-3 py-2 rounded-lg shadow-lg max-w-sm';
                tooltip.textContent = breadcrumb;
                tooltip.style.left = info.jsEvent.pageX + 10 + 'px';
                tooltip.style.top = info.jsEvent.pageY + 10 + 'px';
                document.body.appendChild(tooltip);
            }
        },

        eventMouseLeave: function() {
            var tooltip = document.getElementById('calendar-tooltip');
            if (tooltip) {
                tooltip.remove();
            }
        },
        {% endif %}
    });

    calendar.render();

    // ============================================
    // MODAL FUNCTIONS
    // ============================================

    function openModal(url) {
        modal.classList.remove('hidden');
        modalContent.innerHTML = '<div class="text-center py-10"><i class="fas fa-spinner fa-spin text-3xl text-gray-400"></i><p class="mt-4 text-gray-600">Loading...</p></div>';

        fetch(url, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(function(response) {
            if (!response.ok) throw new Error('Failed to load');
            return response.text();
        })
        .then(function(html) {
            modalContent.innerHTML = html;

            // CRITICAL: Initialize HTMX on dynamically loaded content
            // This makes hx-delete, hx-confirm, and other HTMX attributes work
            if (window.htmx) {
                htmx.process(modalContent);
                console.log('âœ… HTMX initialized on modal content');
            }

            attachModalHandlers();
        })
        .catch(function(error) {
            console.error(error);
            modalContent.innerHTML = '<div class="text-center py-10 text-red-600"><i class="fas fa-exclamation-circle text-3xl"></i><p class="mt-4">Failed to load. Please try again.</p></div>';
        });
    }

    function closeModal() {
        modal.classList.add('hidden');
        modalContent.innerHTML = '';
    }

    function attachModalHandlers() {
        // Close button
        var closeBtn = modalContent.querySelector('[data-close-modal]');
        if (closeBtn) {
            closeBtn.addEventListener('click', closeModal);
        }

        // Note: Delete button now handled by HTMX (hx-delete attribute)
        // HTMX is initialized via htmx.process() after modal content loads
        // No additional JavaScript needed here
    }

    // Close modal on backdrop click
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeModal();
        }
    });

    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
            closeModal();
        }
    });

    // Store calendar globally for debugging
    window.__calendar = calendar;

    {% if USE_UNIFIED_CALENDAR %}
    // ============================================
    // HIERARCHY HELPER FUNCTIONS
    // ============================================

    /**
     * Get Font Awesome icon for work item type (replaces emojis)
     * @param {string} workType - Type of work item
     * @returns {string} HTML string with Font Awesome icon
     */
    function getWorkItemIcon(workType) {
        var icons = {
            'project': '<i class="fas fa-project-diagram mr-1" style="color: #2563EB;"></i>',
            'sub_project': '<i class="fas fa-folder-tree mr-1" style="color: #0284C7;"></i>',
            'activity': '<i class="fas fa-clipboard-list mr-1" style="color: #10B981;"></i>',
            'sub_activity': '<i class="fas fa-list-check mr-1" style="color: #22C55E;"></i>',
            'task': '<i class="fas fa-tasks mr-1" style="color: #8B5CF6;"></i>',
            'subtask': '<i class="fas fa-check-square mr-1" style="color: #A855F7;"></i>'
        };
        return icons[workType] || '<i class="fas fa-circle mr-1" style="color: #9CA3AF;"></i>';
    }

    /**
     * Build event content HTML for month/week views
     * This function generates the complete HTML structure for calendar events
     * Called by eventContent callback (fires on every render, preventing duplication)
     *
     * @param {Object} event - FullCalendar event object
     * @param {Object} workItem - Extended properties from event
     * @returns {string} Complete HTML string for event content
     */
    function buildEventContentHTML(event, workItem) {
        var workType = workItem.workType || '';
        var status = workItem.status || 'not_started';
        var priority = workItem.priority || 'medium';
        var level = workItem.level || 0;
        var originalTitle = event.title;

        // Build compact single-row layout
        var html = '<div class="flex items-center gap-1 text-sm text-gray-900" style="color: inherit;">';

        // Hierarchy indicator (compact)
        if (level > 0) {
            html += '<span class="text-gray-400 text-xs leading-none" aria-hidden="true">â””</span>';
        }

        // Work type icon (inline, no margin)
        var workIcon = getWorkItemIcon(workType).replace('mr-1', '');
        html += '<span class="leading-none" aria-hidden="true">' + workIcon + '</span>';

        // Title text (truncated, flex-1 to take available space)
        html += '<span class="flex-1 truncate font-medium leading-tight text-gray-900" style="color: inherit;">';
        html += originalTitle;
        html += '</span>';

        // Status icon (inline)
        var statusIcon = getStatusIcon(status).replace('ml-1', '');
        html += '<span class="leading-none flex-shrink-0" aria-label="Status: ' + status.replace('_', ' ') + '">';
        html += statusIcon;
        html += '</span>';

        // Priority indicator (critical only, inline)
        if (priority === 'critical') {
            html += '<span class="leading-none flex-shrink-0" aria-label="Critical priority">';
            html += '<i class="fas fa-exclamation-circle text-xs" style="color: #EF4444;" title="Critical"></i>';
            html += '</span>';
        }

        // Time display (inline, only if has specific time)
        var hasTime = workItem.start_time || (event.start && !event.allDay);
        if (hasTime) {
            var timeText = '';
            if (workItem.start_time) {
                timeText = workItem.start_time;
            } else if (event.start && !event.allDay) {
                timeText = event.start.toLocaleTimeString('en-US', {
                    hour: 'numeric',
                    minute: '2-digit'
                });
            }

            if (timeText) {
                html += '<span class="text-xs text-gray-700 flex-shrink-0" style="color: #374151;" aria-label="Time: ' + timeText + '">';
                html += timeText;
                html += '</span>';
            }
        }

        html += '</div>';
        return html;
    }

    /**
     * Get Font Awesome icon for list view (larger, no margins)
     * @param {string} workType - Type of work item
     * @returns {string} HTML string with Font Awesome icon sized for list view
     */
    function getWorkItemIconListView(workType) {
        var icons = {
            'project': '<i class="fas fa-project-diagram" style="color: #3B82F6; font-size: 16px;"></i>',
            'sub_project': '<i class="fas fa-folder-tree" style="color: #0EA5E9; font-size: 16px;"></i>',
            'activity': '<i class="fas fa-clipboard-list" style="color: #059669; font-size: 16px;"></i>',
            'sub_activity': '<i class="fas fa-list-check" style="color: #16A34A; font-size: 16px;"></i>',
            'task': '<i class="fas fa-tasks" style="color: #7C3AED; font-size: 16px;"></i>',
            'subtask': '<i class="fas fa-check-square" style="color: #9333EA; font-size: 16px;"></i>'
        };
        return icons[workType] || '<i class="fas fa-circle" style="color: #9CA3AF; font-size: 16px;"></i>';
    }

    /**
     * Get status indicator icon
     * @param {string} status - Current status of work item
     * @returns {string} HTML string with status icon
     */
    function getStatusIcon(status) {
        var icons = {
            'not_started': '<i class="far fa-circle text-xs ml-1" style="color: #9CA3AF;" title="Not Started"></i>',
            'in_progress': '<i class="fas fa-spinner text-xs ml-1" style="color: #3B82F6;" title="In Progress"></i>',
            'at_risk': '<i class="fas fa-exclamation-triangle text-xs ml-1" style="color: #F59E0B;" title="At Risk"></i>',
            'blocked': '<i class="fas fa-ban text-xs ml-1" style="color: #EF4444;" title="Blocked"></i>',
            'completed': '<i class="fas fa-check-circle text-xs ml-1" style="color: #10B981;" title="Completed"></i>',
            'cancelled': '<i class="fas fa-times-circle text-xs ml-1" style="color: #6B7280;" title="Cancelled"></i>'
        };
        return icons[status] || '';
    }

    /**
     * Get priority badge (only for critical/urgent)
     * @param {string} priority - Priority level
     * @returns {string} HTML string for priority badge
     */
    function getPriorityBadge(priority) {
        if (priority === 'critical') {
            return '<span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-bold bg-red-100 text-red-800 ml-1 border border-red-200">CRITICAL</span>';
        }
        if (priority === 'urgent') {
            return '<i class="fas fa-flag text-xs ml-1" style="color: #F59E0B;" title="Urgent"></i>';
        }
        return '';
    }

    function toggleWorkItemChildren(parentId) {
        var allEvents = calendar.getEvents();
        var parent = allEvents.find(function(e) { return e.id === parentId; });
        if (!parent) return;

        var parentExtended = parent.extendedProps;
        var isExpanded = parentExtended.expanded || false;

        // Find all direct children
        var children = allEvents.filter(function(e) {
            return e.extendedProps.parentId === parentId;
        });

        // Toggle visibility
        children.forEach(function(child) {
            child.setProp('display', isExpanded ? 'none' : 'auto');
        });

        // Update parent state
        parent.setExtendedProp('expanded', !isExpanded);

        // Update expand button icon
        var parentEl = document.querySelector('[data-event-id="' + parentId + '"] .expand-btn');
        if (parentEl) {
            parentEl.innerHTML = isExpanded ? '<i class="fas fa-chevron-right text-xs"></i>' : '<i class="fas fa-chevron-down text-xs"></i>';
        }
    }

    // ============================================
    // TYPE FILTERING
    // ============================================

    function applyCalendarFilters() {
        var projectChecked = document.querySelector('[data-filter="project"]').checked;
        var activityChecked = document.querySelector('[data-filter="activity"]').checked;
        var taskChecked = document.querySelector('[data-filter="task"]').checked;
        var showCompleted = document.querySelector('[data-filter="completed"]').checked;

        var allEvents = calendar.getEvents();
        allEvents.forEach(function(event) {
            var workType = event.extendedProps.workType || '';
            var status = event.extendedProps.status || '';
            var show = true;

            // Type filter
            if (workType.includes('project')) {
                show = show && projectChecked;
            } else if (workType.includes('activity')) {
                show = show && activityChecked;
            } else if (workType.includes('task')) {
                show = show && taskChecked;
            }

            // Completed filter
            if (!showCompleted && status === 'completed') {
                show = false;
            }

            event.setProp('display', show ? 'auto' : 'none');
        });
    }

    // Attach filter listeners
    document.querySelectorAll('[data-filter]').forEach(function(checkbox) {
        checkbox.addEventListener('change', applyCalendarFilters);
    });
    {% endif %}

    console.log('âœ… {% if USE_UNIFIED_CALENDAR %}Unified hierarchy{% else %}Simple{% endif %} calendar initialized');

    // Debug: Log when events are loaded and update stats
    calendar.on('eventsSet', function(events) {
        console.log('ðŸ“… Calendar events loaded:', events.length, 'events');
        if (events.length === 0) {
            console.warn('âš ï¸  No events to display! Check the feed endpoint.');
        }

        // Update stat cards
        updateStatCards(events);
    });

    // Update stat cards based on events
    function updateStatCards(events) {
        var totalItems = events.length;
        var upcoming = 0;
        var inProgress = 0;
        var completed = 0;
        var now = new Date();
        var weekFromNow = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);

        events.forEach(function(event) {
            var status = event.extendedProps.status || '';
            var startDate = event.start ? new Date(event.start) : null;

            // Count completed
            if (status === 'completed') {
                completed++;
            }
            // Count in progress
            else if (status === 'in_progress' || status === 'ongoing') {
                inProgress++;
            }
            // Count upcoming (events in next 7 days)
            if (startDate && startDate >= now && startDate <= weekFromNow) {
                upcoming++;
            }
        });

        // Update DOM
        document.getElementById('stat-total-items').textContent = totalItems;
        document.getElementById('stat-upcoming').textContent = upcoming;
        document.getElementById('stat-in-progress').textContent = inProgress;
        document.getElementById('stat-completed').textContent = completed;
    }

    // ============================================
    // CRITICAL: Manual HX-Trigger Header Processing
    // ============================================
    // HTMX should dispatch HX-Trigger events automatically, but we manually
    // process them to ensure reliability across all HTMX versions and scenarios
    document.body.addEventListener('htmx:afterRequest', function(event) {
        var xhr = event.detail.xhr;
        var triggerHeader = xhr.getResponseHeader('HX-Trigger');

        if (triggerHeader) {
            console.log('ðŸ“¨ HX-Trigger header received:', triggerHeader);

            try {
                var triggers = JSON.parse(triggerHeader);
                Object.keys(triggers).forEach(function(triggerName) {
                    var triggerData = triggers[triggerName];

                    console.log('ðŸ”” Dispatching event:', triggerName, triggerData);

                    document.body.dispatchEvent(new CustomEvent(triggerName, {
                        detail: triggerData
                    }));
                });
            } catch (e) {
                console.error('âŒ Failed to parse HX-Trigger header:', e);
            }
        }
    });

    // ============================================
    // HTMX event listeners for work item actions
    // ============================================
    // These listen to custom events dispatched from HX-Trigger headers
    document.body.addEventListener('workItemDeleted', function(event) {
        console.log('ðŸ—‘ï¸  Work item deleted:', event.detail);

        var workItemId = String(event.detail.id);
        var allEvents = calendar.getEvents();

        console.log('ðŸ” Searching for work item ID:', workItemId);
        console.log('ðŸ“Š Total events in calendar:', allEvents.length);

        // Build all possible ID formats (current and legacy)
        var possibleIds = [
            workItemId,                           // Raw UUID
            'work-item-' + workItemId,           // Current WorkItem format
            'coordination-event-' + workItemId,  // Legacy coordination format
            'staff-task-' + workItemId           // Legacy staff task format
        ];

        console.log('ðŸ”Ž Searching for IDs:', possibleIds);

        // Use Array.find() instead of getEventById() for reliable matching
        // This bypasses FullCalendar's getEventById() which may have version-specific issues
        var calendarEvent = allEvents.find(function(evt) {
            var isMatch = possibleIds.indexOf(evt.id) !== -1;
            if (isMatch) {
                console.log('âœ… Found match:', evt.id);
            }
            return isMatch;
        });

        if (calendarEvent) {
            calendarEvent.remove();
            console.log('âœ… Removed event from calendar with ID:', calendarEvent.id);
        } else {
            console.warn('âš ï¸  Could not find calendar event, triggering full refresh');
            console.warn('âš ï¸  Searched for IDs:', possibleIds.join(', '));
            console.warn('âš ï¸  Available event IDs:', allEvents.map(function(e) { return e.id; }).join(', '));
            // Fallback: Refresh entire calendar
            calendar.refetchEvents();
        }

        // Close modal
        closeModal();

        // Show success message
        var message = event.detail.type + ' "' + event.detail.title + '" deleted successfully';
        console.log('âœ…', message);
    });

    document.body.addEventListener('refreshCalendar', function() {
        console.log('ðŸ”„ Refreshing calendar...');
        calendar.refetchEvents();
    });

    document.body.addEventListener('showToast', function(event) {
        var detail = event.detail;
        var message = detail.message || 'Action completed';
        var level = detail.level || 'info';

        console.log('ðŸ“¬ Toast:', level.toUpperCase(), '-', message);

        // Simple alert for now (replace with proper toast UI later)
        if (level === 'success') {
            alert('âœ… ' + message);
        } else if (level === 'error') {
            alert('âŒ ' + message);
        } else {
            alert(message);
        }
    });

})();
</script>

{% endblock %}
