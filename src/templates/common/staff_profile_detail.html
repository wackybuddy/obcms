{% extends 'base.html' %}
{% load static %}

{% block title %}{{ profile.user.get_full_name|default:profile.user.username }} - Staff Profile{% endblock %}

{% block extra_css %}
<!-- FullCalendar CSS for calendar widget -->
<link href="{% static 'common/vendor/fullcalendar/main.min.css' %}" rel="stylesheet">
{% endblock %}

{% block breadcrumb %}
<li class="flex items-center space-x-2">
    <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
    <a href="{% url 'common:oobc_management_home' %}" class="text-gray-600 hover:text-gray-900">OOBC Management</a>
</li>
<li class="flex items-center space-x-2">
    <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
    <a href="{% url 'common:staff_profiles_list' %}" class="text-gray-600 hover:text-gray-900">Staff Profiles</a>
</li>
<li class="flex items-center space-x-2">
    <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
    <span class="text-gray-500 font-medium">{{ profile.user.get_full_name|default:profile.user.username }}</span>
</li>
{% endblock %}

{% block extra_js %}
<!-- FullCalendar JS for calendar widget -->
<script src="{% static 'common/vendor/fullcalendar/index.global.min.js' %}"></script>

<script src="{% static 'common/js/task_modal_enhancements.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const navContainer = document.getElementById('staffProfileTabs');
        const panelsContainer = document.getElementById('staffProfileTabPanels');

        if (!navContainer || !panelsContainer) {
            return;
        }

        const navTriggers = navContainer.querySelectorAll('[data-tab-target]');
        const panelTriggers = panelsContainer.querySelectorAll('[data-tab-target]');
        const triggerSet = new Set();
        navTriggers.forEach(trigger => triggerSet.add(trigger));
        panelTriggers.forEach(trigger => triggerSet.add(trigger));
        const panels = panelsContainer.querySelectorAll('[data-tab-content]');

        const ACTIVE_CLASSES = ['bg-emerald-50', 'border-emerald-200', 'text-emerald-700', 'shadow-sm'];
        const INACTIVE_CLASSES = ['bg-white', 'border-transparent', 'text-gray-600', 'hover:text-gray-900', 'hover:bg-gray-50'];
        const ICON_ACTIVE_CLASSES = ['text-emerald-600'];
        const ICON_INACTIVE_CLASSES = ['text-gray-400', 'group-hover:text-gray-500'];

        function setNavTriggerState(trigger, isActive) {
            trigger.setAttribute('aria-selected', isActive ? 'true' : 'false');

            ACTIVE_CLASSES.forEach(cls => trigger.classList.toggle(cls, isActive));
            INACTIVE_CLASSES.forEach(cls => trigger.classList.toggle(cls, !isActive));

            const icon = trigger.querySelector('i');
            if (icon) {
                ICON_ACTIVE_CLASSES.forEach(cls => icon.classList.toggle(cls, isActive));
                ICON_INACTIVE_CLASSES.forEach(cls => icon.classList.toggle(cls, !isActive));
            }
        }

        function updatePanels(tabKey) {
            panels.forEach(panel => {
                const isActive = panel.dataset.tabContent === tabKey;
                panel.classList.toggle('hidden', !isActive);
                panel.setAttribute('aria-hidden', isActive ? 'false' : 'true');
            });
            panelsContainer.dataset.activeTab = tabKey;
        }

        function updateLocation(tabKey) {
            const url = new URL(window.location.href);
            if (tabKey === 'overview') {
                url.searchParams.delete('tab');
            } else {
                url.searchParams.set('tab', tabKey);
            }
            window.history.replaceState({}, '', url.toString());
        }

        function activateTab(tabKey, options = {}) {
            const navTrigger = navContainer.querySelector(`[data-tab-target="${tabKey}"]`);
            if (!navTrigger) {
                return;
            }

            navTriggers.forEach(trigger => setNavTriggerState(trigger, trigger === navTrigger));
            updatePanels(tabKey);

            const shouldFocus = Boolean(options.shouldFocus);
            const shouldUpdateUrl = options.updateUrl !== false;

            if (shouldFocus) {
                navTrigger.focus();
            }

            if (shouldUpdateUrl) {
                updateLocation(tabKey);
            }
        }

        function handleTriggerClick(event) {
            const trigger = event.currentTarget;
            const tabKey = trigger.dataset.tabTarget;

            if (!tabKey) {
                return;
            }

            if (event.button !== undefined && event.button !== 0) {
                return;
            }

            if (event.metaKey || event.ctrlKey || event.shiftKey || event.altKey) {
                return;
            }

            const isNavTrigger = navContainer.contains(trigger);

            event.preventDefault();
            activateTab(tabKey, { shouldFocus: isNavTrigger });
        }

        triggerSet.forEach(trigger => {
            trigger.addEventListener('click', handleTriggerClick);
        });

        const initialTab = panelsContainer.dataset.activeTab;
        if (initialTab) {
            activateTab(initialTab, { updateUrl: false });
        }
    });

    document.addEventListener('DOMContentLoaded', function () {
        const modal = document.getElementById('taskModal');
        const modalContent = document.getElementById('taskModalContent');

        if (!modal || !modalContent) {
            return;
        }

        function ensureHtmx(callback) {
            if (window.htmx) {
                callback();
                return;
            }

            const existingLoader = document.querySelector('script[data-dynamic-htmx="true"]');
            const onLoad = function () {
                if (typeof callback === 'function') {
                    callback();
                }
            };

            if (existingLoader) {
                existingLoader.addEventListener('load', onLoad, { once: true });
                return;
            }

            const script = document.createElement('script');
            script.src = 'https://unpkg.com/htmx.org@1.9.10';
            script.defer = true;
            script.dataset.dynamicHtmx = 'true';
            script.addEventListener('load', onLoad, { once: true });
            document.head.appendChild(script);
        }

        const loadingMarkup = [
            '<div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full">',
            '  <div class="px-6 py-12 text-center text-sm text-gray-500">Loading task details...</div>',
            '</div>'
        ].join('');

        function openTaskModal(url) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            modalContent.innerHTML = loadingMarkup;

            ensureHtmx(function () {
                if (window.htmx) {
                    window.htmx.ajax('GET', url, { target: modalContent, swap: 'innerHTML' });
                }
            });
        }

        function closeTaskModal() {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            modalContent.innerHTML = '';
        }

        document.body.addEventListener('click', function (event) {
            if (event.target.matches('[data-modal-backdrop]') || event.target.closest('[data-close-modal]')) {
                event.preventDefault();
                closeTaskModal();
                return;
            }

            const trigger = event.target.closest('[data-modal-link]');
            if (trigger) {
                event.preventDefault();
                const href = trigger.getAttribute('href');
                if (href) {
                    openTaskModal(href);
                }
            }
        });

        document.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') {
                closeTaskModal();
            }
        });

        document.body.addEventListener('task-modal-close', function () {
            closeTaskModal();
        });

        document.body.addEventListener('task-board-refresh', function () {
            closeTaskModal();
            window.setTimeout(function () {
                window.location.reload();
            }, 150);
        });

        document.body.addEventListener('htmx:afterSwap', function (event) {
            if (event.target && event.target.id === 'taskModalContent') {
                if (window.taskModalEnhancer && typeof window.taskModalEnhancer.init === 'function') {
                    window.taskModalEnhancer.init(event.target);
                }
            }
        });
    });
</script>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-8">
    <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-6">
        <div class="space-y-1">
            <h1 class="text-3xl font-bold text-gray-900">{{ profile.user.get_full_name|default:profile.user.username }}</h1>
            <p class="text-lg text-gray-600">{{ profile.user.position|default:"Role not set" }}</p>
            <p class="text-sm text-gray-500">Username: {{ profile.user.username }}</p>
        </div>
        <div class="flex flex-wrap items-center gap-3">
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold
                {% if profile.employment_status == 'active' %}bg-emerald-100 text-emerald-700
                {% elif profile.employment_status == 'on_leave' %}bg-amber-100 text-amber-700
                {% else %}bg-gray-200 text-gray-600{% endif %}">
                {{ profile.get_employment_status_display }}
            </span>
            {% if profile.employment_type %}
            <span class="inline-flex items-center px-3 py-1 rounded-full bg-blue-50 text-blue-700 text-sm font-semibold">{{ profile.get_employment_type_display }}</span>
            {% endif %}
            {% if can_edit_profile %}
            <a href="{% url 'common:staff_profile_update' profile.pk %}"
               class="inline-flex items-center px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-semibold rounded-lg transition-colors">
                <i class="fas fa-edit mr-2"></i>
                Edit profile
            </a>
            {% endif %}
            {% if allow_delete %}
            <a href="{% url 'common:staff_profile_delete' profile.pk %}"
               class="inline-flex items-center px-4 py-2 bg-white border border-rose-200 text-rose-600 hover:bg-rose-50 text-sm font-semibold rounded-lg transition-colors">
                <i class="fas fa-trash mr-2"></i>
                Delete
            </a>
            {% endif %}
        </div>
    </div>

    <div class="bg-white border border-gray-200 rounded-2xl shadow-sm overflow-hidden" id="staffProfileTabs">
        <div class="px-3 sm:px-6 py-3 border-b border-gray-100">
            <nav class="flex flex-nowrap gap-2 overflow-x-auto text-sm" role="tablist" aria-label="Staff profile sections">
                {% for tab in tabs %}
                <a href="{{ tab.url }}"
                   class="tab-trigger group inline-flex items-center whitespace-nowrap rounded-xl border px-4 py-2 font-semibold transition-all duration-150
                       {% if tab.is_active %}bg-emerald-50 border-emerald-200 text-emerald-700 shadow-sm
                       {% else %}bg-white border-transparent text-gray-600 hover:text-gray-900 hover:bg-gray-50{% endif %}"
                   role="tab"
                   id="{{ tab.key }}-tab"
                   aria-controls="{{ tab.key }}-panel"
                   data-tab-target="{{ tab.key }}"
                   {% if tab.is_active %}aria-selected="true"{% else %}aria-selected="false"{% endif %}>
                    <i class="{{ tab.icon }} text-sm mr-2
                        {% if tab.is_active %}text-emerald-600{% else %}text-gray-400 group-hover:text-gray-500{% endif %}"></i>
                    {{ tab.label }}
                </a>
                {% endfor %}
            </nav>
        </div>
        <div class="p-6 bg-gray-50 border-t border-gray-100">
            <p class="text-sm text-gray-500">
                Use the tabs to review account information, role expectations, competencies, performance, and tasks for {{ profile.user.get_full_name|default:profile.user.username }}.
            </p>
        </div>
    </div>

    <div class="space-y-8" id="staffProfileTabPanels" data-active-tab="{{ active_tab }}">
        <div class="space-y-8 {% if active_tab != 'account' %}hidden{% endif %}" id="account-panel" data-tab-content="account" role="tabpanel" aria-labelledby="account-tab">
            {% include 'common/staff_profile/tabs/_account.html' %}
        </div>
        <div class="space-y-8 {% if active_tab != 'overview' %}hidden{% endif %}" id="overview-panel" data-tab-content="overview" role="tabpanel" aria-labelledby="overview-tab">
            {% include 'common/staff_profile/tabs/_overview.html' %}
        </div>
        <div class="space-y-8 {% if active_tab != 'job' %}hidden{% endif %}" id="job-panel" data-tab-content="job" role="tabpanel" aria-labelledby="job-tab">
            {% include 'common/staff_profile/tabs/_job_description.html' %}
        </div>
        <div class="space-y-8 {% if active_tab != 'competency' %}hidden{% endif %}" id="competency-panel" data-tab-content="competency" role="tabpanel" aria-labelledby="competency-tab">
            {% include 'common/staff_profile/tabs/_competency.html' %}
        </div>
        <div class="space-y-8 {% if active_tab != 'performance' %}hidden{% endif %}" id="performance-panel" data-tab-content="performance" role="tabpanel" aria-labelledby="performance-tab">
            {% include 'common/staff_profile/tabs/_performance.html' %}
        </div>
        <div class="space-y-8 {% if active_tab != 'tasks' %}hidden{% endif %}" id="tasks-panel" data-tab-content="tasks" role="tabpanel" aria-labelledby="tasks-tab">
            {% include 'common/staff_profile/tabs/_tasks.html' %}
        </div>
    </div>
</div>

<!-- Right Sidebar Panel for Work Item Creation -->
<aside id="work-item-sidebar"
       class="fixed top-0 right-0 h-full w-96 bg-white border-l border-gray-200 shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out z-50">
    <div class="h-full flex flex-col">
        <!-- Sidebar Content (HTMX target) -->
        <div id="sidebar-content" class="flex-1 overflow-y-auto p-6">
            <div class="text-center text-gray-500 py-8">
                <i class="fas fa-tasks text-4xl mb-3"></i>
                <p>Click "Create work item" to get started</p>
            </div>
        </div>
    </div>
</aside>

<!-- Sidebar Backdrop -->
<div id="sidebar-backdrop"
     class="fixed inset-0 bg-black/50 z-40 opacity-0 pointer-events-none transition-opacity duration-300"
     onclick="closeSidebar()"></div>

<script>
/**
 * Sidebar Panel Functionality for Staff Profile Work Items
 */
(function() {
    'use strict';

    /**
     * Open the sidebar panel with smooth transition
     */
    window.openSidebar = function() {
        const sidebar = document.getElementById('work-item-sidebar');
        const backdrop = document.getElementById('sidebar-backdrop');

        if (sidebar && backdrop) {
            sidebar.classList.remove('translate-x-full');
            backdrop.classList.remove('opacity-0', 'pointer-events-none');
            backdrop.classList.add('opacity-100', 'pointer-events-auto');
            console.log('[Sidebar] Opened');
        }
    };

    /**
     * Open sidebar and load content via HTMX
     * @param {HTMLElement} button - Button element with data-hx-get and data-hx-target attributes
     */
    window.openSidebarAndLoad = function(button) {
        // First, open the sidebar
        openSidebar();

        // Get HTMX attributes from button
        const url = button.getAttribute('data-hx-get');
        const target = button.getAttribute('data-hx-target');

        if (!url || !target) {
            console.error('[Sidebar] Missing data-hx-get or data-hx-target attribute');
            return;
        }

        // Wait a tiny bit for sidebar animation to start, then trigger HTMX
        setTimeout(() => {
            htmx.ajax('GET', url, {
                target: target,
                swap: 'innerHTML'
            });
        }, 50);
    };

    /**
     * Close the sidebar panel and clear content
     */
    window.closeSidebar = function() {
        const sidebar = document.getElementById('work-item-sidebar');
        const backdrop = document.getElementById('sidebar-backdrop');

        if (sidebar && backdrop) {
            sidebar.classList.add('translate-x-full');
            backdrop.classList.remove('opacity-100', 'pointer-events-auto');
            backdrop.classList.add('opacity-0', 'pointer-events-none');
            console.log('[Sidebar] Closed');
        }
    };

    /**
     * Listen for HTMX afterSwap to process loaded content in sidebar
     */
    document.body.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.id === 'sidebar-content') {
            console.log('[Sidebar] Content loaded');
            // Process HTMX attributes in the new content
            htmx.process(event.detail.target);
        }
    });

    /**
     * Listen for workItemCreated event to close sidebar and refresh tasks tab
     */
    document.body.addEventListener('workItemCreated', function(event) {
        console.log('[Sidebar] Work item created, closing sidebar and reloading tasks tab');
        closeSidebar();
        // Reload page to show new work item in tasks list
        window.location.reload();
    });

    /**
     * Listen for custom close event from backend
     */
    document.body.addEventListener('closeSidebar', function(event) {
        console.log('[Sidebar] Close event triggered');
        closeSidebar();
    });

    /**
     * Display toast notification
     * @param {string} message - Notification message
     * @param {string} level - Notification level (success, error, warning, info)
     */
    function showToast(message, level = 'info') {
        // Remove existing toasts
        const existingToast = document.getElementById('work-item-toast');
        if (existingToast) existingToast.remove();

        // Create toast element
        const toast = document.createElement('div');
        toast.id = 'work-item-toast';
        toast.className = 'fixed top-20 right-4 z-[9999] px-6 py-4 rounded-xl shadow-2xl transform transition-all duration-300 ease-out';

        // Color schemes based on level
        const colors = {
            success: 'bg-emerald-600 text-white',
            error: 'bg-red-600 text-white',
            warning: 'bg-amber-600 text-white',
            info: 'bg-blue-600 text-white'
        };

        const icons = {
            success: 'fa-check-circle',
            error: 'fa-times-circle',
            warning: 'fa-exclamation-triangle',
            info: 'fa-info-circle'
        };

        toast.className += ' ' + (colors[level] || colors.info);

        toast.innerHTML = `
            <div class="flex items-center gap-3">
                <i class="fas ${icons[level] || icons.info} text-xl"></i>
                <span class="font-medium">${message}</span>
                <button onclick="this.closest('#work-item-toast').remove()" class="ml-4 text-white/80 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;

        // Add to DOM with animation
        document.body.appendChild(toast);
        setTimeout(() => toast.style.transform = 'translateY(0)', 10);

        // Auto-remove after 5 seconds
        setTimeout(() => {
            toast.style.transform = 'translateY(-100%)';
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 5000);
    }

    /**
     * Listen for showToast events from HTMX responses
     */
    document.body.addEventListener('showToast', function(event) {
        const { message, level } = event.detail;
        showToast(message, level);
    });

    console.log('âœ… Staff profile sidebar functionality initialized');
})();
</script>
{% endblock %}
