{% extends "base.html" %}
{% load static %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'vendor/leaflet/leaflet.css' %}">
<link rel="stylesheet" href="{% static 'common/css/obc_location_map.css' %}">
{% endblock %}

{% block title %}Log MOA PPA{% endblock %}

{% block breadcrumb %}
<li>
    <a href="{% url 'common:dashboard' %}" class="text-neutral-500 hover:text-neutral-700">Dashboard</a>
</li>
<li><span class="text-neutral-400 mx-1">/</span></li>
<li>
    <a href="{% url 'monitoring:home' %}" class="text-neutral-500 hover:text-neutral-700">Monitoring &amp; Evaluation</a>
</li>
<li><span class="text-neutral-400 mx-1">/</span></li>
<li class="text-neutral-800 font-semibold">Log MOA PPA</li>
{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-10 space-y-8">
    <header class="rounded-2xl bg-gradient-to-r from-blue-500 via-indigo-500 to-cyan-500 text-white shadow-lg p-6">
        <div class="flex items-center gap-4">
            <span class="w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center text-2xl"><i class="fas fa-building-columns"></i></span>
            <div>
                <h1 class="text-2xl font-semibold">Log MOA Project / Program / Activity</h1>
                <p class="text-white/80">Document a ministry-led initiative that OBC communities can access.</p>
            </div>
        </div>
    </header>

    <form method="post" class="obc-form space-y-8">
        {% csrf_token %}

        <section class="bg-white border border-neutral-200 rounded-2xl shadow-sm p-6 space-y-6">
            <div class="flex items-center gap-3">
                <span class="w-9 h-9 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center"><i class="fas fa-info"></i></span>
                <div>
                    <h2 class="text-lg font-semibold text-neutral-800">PPA Overview</h2>
                    <p class="text-sm text-neutral-500">Outline the core details of the programme or activity.</p>
                </div>
            </div>
            <div class="grid gap-5 md:grid-cols-2">
                {% include "monitoring/includes/form_field.html" with field=form.implementing_moa %}
                {% include "monitoring/includes/form_field.html" with field=form.title label_override="PPA Title" %}
                <div class="md:col-span-2">
                    {% include "monitoring/includes/form_field.html" with field=form.summary label_override="PPA Description" %}
                </div>
                {% include "monitoring/includes/form_field.html" with field=form.budget_allocation label_override="PPA Approved Budget" %}
                {% include "monitoring/includes/form_field.html" with field=form.budget_obc_allocation label_override="Budget Allocation for OBCs" %}
                {% include "monitoring/includes/form_field.html" with field=form.total_slots label_override="Total Number of Slots" %}
                {% include "monitoring/includes/form_field.html" with field=form.obc_slots label_override="Number of Slots for OBCs" %}
            </div>
        </section>

        <section class="bg-white border border-neutral-200 rounded-2xl shadow-sm p-6 space-y-6">
            <div class="flex items-center gap-3">
                <span class="w-9 h-9 rounded-lg bg-sky-100 text-sky-600 flex items-center justify-center"><i class="fas fa-calendar"></i></span>
                <div>
                    <h2 class="text-lg font-semibold text-neutral-800">Timeline &amp; Resources</h2>
                    <p class="text-sm text-neutral-500">Track implementation progress and resource allocation.</p>
                </div>
            </div>
            <div class="grid gap-5 md:grid-cols-2">
                {% include "monitoring/includes/form_field.html" with field=form.status %}
                {% include "monitoring/includes/form_field.html" with field=form.progress %}
                {% include "monitoring/includes/form_field.html" with field=form.start_date %}
                {% include "monitoring/includes/form_field.html" with field=form.target_end_date %}
            </div>
        </section>

        <section class="bg-white border border-neutral-200 rounded-2xl shadow-sm p-6 space-y-6">
            <div class="flex items-center gap-3">
                <span class="w-9 h-9 rounded-lg bg-emerald-100 text-emerald-600 flex items-center justify-center"><i class="fas fa-map-marker-alt"></i></span>
                <div>
                    <h2 class="text-lg font-semibold text-neutral-800">Geographic Coverage</h2>
                    <p class="text-sm text-neutral-500">Identify the areas where the PPA is available to OBCs.</p>
                </div>
            </div>
            <div class="space-y-5" id="coverage-rows">
                <div class="space-y-3" data-coverage-row="primary">
                    <div class="grid gap-5 md:grid-cols-2 lg:grid-cols-4">
                        {% include "monitoring/includes/form_field.html" with field=form.coverage_region label_override="Region" %}
                        {% include "monitoring/includes/form_field.html" with field=form.coverage_province label_override="Province" %}
                        {% include "monitoring/includes/form_field.html" with field=form.coverage_municipality label_override="Municipality / City" %}
                        {% include "monitoring/includes/form_field.html" with field=form.coverage_barangay label_override="Barangay" %}
                    </div>
                    <div class="obc-map-container" data-coverage-map="primary" data-obc-map data-mode="coverage" data-region-field="id_coverage_region" data-province-field="id_coverage_province" data-municipality-field="id_coverage_municipality" data-barangay-field="id_coverage_barangay" data-location-script="location-data" data-centroid-url="{% url 'communities:location_centroid' %}">
                        <div class="obc-map-header">
                            <h3 class="flex items-center gap-2 text-neutral-800"><i class="fas fa-map-marker-alt text-blue-500"></i>Coverage Map</h3>
                            <span class="obc-map-status"><i class="fas fa-crosshairs"></i>Select a location to drop a pin</span>
                        </div>
                        <div class="obc-map-canvas" data-obc-map-target></div>
                        <div class="obc-map-footer">
                            Pins update automatically when you choose a barangay or municipality.
                        </div>
                    </div>
                </div>
                <div class="space-y-3" id="additional-coverage-rows"></div>
            </div>
            <template id="coverage-row-template">
                <div class="space-y-3" data-coverage-row>
                    <div class="grid gap-5 md:grid-cols-2 lg:grid-cols-4">
                        <div>
                            <label class="block text-sm font-medium text-neutral-700 mb-1">Region</label>
                            <select data-field="region" data-placeholder="Select region..." class="block w-full px-4 py-3 rounded-xl border border-neutral-200 bg-white shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm transition"></select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-neutral-700 mb-1">Province</label>
                            <select data-field="province" data-placeholder="Select province..." class="block w-full px-4 py-3 rounded-xl border border-neutral-200 bg-white shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm transition"></select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-neutral-700 mb-1">Municipality / City</label>
                            <select data-field="municipality" data-placeholder="Select municipality / city..." class="block w-full px-4 py-3 rounded-xl border border-neutral-200 bg-white shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm transition"></select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-neutral-700 mb-1">Barangay</label>
                            <select data-field="barangay" data-placeholder="Select barangay..." class="block w-full px-4 py-3 rounded-xl border border-neutral-200 bg-white shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm transition"></select>
                        </div>
                    </div>
                    <div class="obc-map-container" data-coverage-map data-obc-map data-mode="coverage" data-location-script="location-data" data-centroid-url="{% url 'communities:location_centroid' %}">
                        <div class="obc-map-header">
                            <h3 class="flex items-center gap-2 text-neutral-800"><i class="fas fa-map-marker-alt text-blue-500"></i>Coverage Map</h3>
                            <span class="obc-map-status"><i class="fas fa-crosshairs"></i>Select a location to drop a pin</span>
                        </div>
                        <div class="obc-map-canvas" data-obc-map-target></div>
                        <div class="obc-map-footer">
                            Pins update automatically when you choose a barangay or municipality.
                        </div>
                    </div>
                    <div class="flex justify-end">
                        <button type="button" class="inline-flex items-center gap-1 text-sm text-neutral-500 hover:text-red-500" data-action="remove-row">
                            <i class="fas fa-times"></i>
                            Remove
                        </button>
                    </div>
                </div>
            </template>
            <div class="flex items-center justify-end">
                <button type="button" id="add-coverage-row" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-blue-600 text-white text-sm font-medium shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    <i class="fas fa-plus"></i>
                    Add More OBC
                </button>
            </div>
            <div style="display:none" aria-hidden="true">
                {{ form.communities }}
            </div>
            <div class="md:col-span-2">
                {% include "monitoring/includes/form_field.html" with field=form.obcs_benefited label_override="OBCs Benefited from the PPA" %}
            </div>
            <div class="flex justify-end">
                <button type="button" id="save-obc-locations" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-emerald-600 text-white text-sm font-medium shadow-sm hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2">
                    <i class="fas fa-save"></i>
                    Save OBC Locations
                </button>
            </div>
        </section>
        <div class="flex justify-end gap-3">
            <a href="{% url 'monitoring:home' %}" class="px-4 py-2 rounded-lg border border-neutral-300 text-neutral-600 hover:bg-neutral-100">Cancel</a>
            <button type="submit" class="px-4 py-2 rounded-lg btn-primary font-semibold">Save MOA PPA</button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
{{ location_data|json_script:"location-data" }}
{{ community_locations|json_script:"community-locations" }}
<script src="{% static 'vendor/leaflet/leaflet.js' %}"></script>
<script src="{% static 'common/js/obc_location_map.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const locationDataElement = document.getElementById('location-data');
    const communityDataElement = document.getElementById('community-locations');
    if (!locationDataElement || !communityDataElement) {
        return;
    }

    let locationData;
    try {
        locationData = JSON.parse(locationDataElement.textContent);
    } catch (error) {
        console.error('Unable to parse location data for coverage selectors.', error);
        return;
    }

    let communityData = [];
    try {
        communityData = JSON.parse(communityDataElement.textContent) || [];
    } catch (error) {
        console.warn('Unable to parse community lookup data.', error);
    }

    const mapByKey = (items, keyFn) => {
        const map = new Map();
        (items || []).forEach(item => {
            const key = String(keyFn(item));
            if (!map.has(key)) {
                map.set(key, []);
            }
            map.get(key).push(item);
        });
        return map;
    };

    const provincesByRegion = mapByKey(locationData.provinces, province => province.region_id);
    const municipalitiesByProvince = mapByKey(locationData.municipalities, municipality => municipality.province_id);
    const barangaysByMunicipality = mapByKey(locationData.barangays, barangay => barangay.municipality_id);

    const toStringId = value => (value === null || value === undefined ? '' : String(value));

    const autoMunicipalityByProvince = new Map();
    (locationData.provinces || []).forEach(province => {
        const provinceKey = toStringId(province.id);
        if (!provinceKey) {
            return;
        }
        const autoMunicipalityId = province.auto_municipality_id;
        const isPseudo = Boolean(province.is_pseudo_province) || Boolean(autoMunicipalityId);
        if (!isPseudo) {
            return;
        }
        if (autoMunicipalityId !== null && autoMunicipalityId !== undefined) {
            autoMunicipalityByProvince.set(provinceKey, toStringId(autoMunicipalityId));
            return;
        }
        const options = municipalitiesByProvince.get(provinceKey) || [];
        if (!options.length) {
            return;
        }
        const independentCity = options.find(
            municipality => municipality.municipality_type === 'independent_city'
        );
        const target = independentCity || options[0];
        if (target && target.id !== undefined && target.id !== null) {
            autoMunicipalityByProvince.set(provinceKey, toStringId(target.id));
        }
    });

    const setOptions = (select, options, placeholder, selectedValue, labelFn) => {
        if (!select) {
            return;
        }

        const desired = toStringId(selectedValue);
        const fragment = document.createDocumentFragment();

        const placeholderOption = document.createElement('option');
        placeholderOption.value = '';
        placeholderOption.textContent = placeholder;
        fragment.appendChild(placeholderOption);

        (options || []).forEach(option => {
            const optionElement = document.createElement('option');
            optionElement.value = String(option.id);
            optionElement.textContent = labelFn ? labelFn(option) : option.name;
            if (Object.prototype.hasOwnProperty.call(option, 'code') && option.code) {
                optionElement.dataset.code = option.code;
            }
            if (
                Object.prototype.hasOwnProperty.call(option, 'is_pseudo_province') &&
                option.is_pseudo_province
            ) {
                optionElement.dataset.isPseudoProvince = 'true';
            }
            if (
                Object.prototype.hasOwnProperty.call(option, 'municipality_type') &&
                option.municipality_type
            ) {
                optionElement.dataset.municipalityType = option.municipality_type;
            }
            fragment.appendChild(optionElement);
        });

        select.innerHTML = '';
        select.appendChild(fragment);

        const hasDesired = (options || []).some(option => String(option.id) === desired);
        select.value = hasDesired ? desired : '';
    };

    const communitiesSelect = document.getElementById('id_communities');
    const communityById = new Map();
    const communityByBarangay = new Map();
    const municipalityCommunityById = new Map();

    communityData.forEach(community => {
        const id = String(community.id);
        communityById.set(id, community);
        if (community.type === 'community' && community.barangay_id) {
            communityByBarangay.set(String(community.barangay_id), community);
        }
        if (community.type === 'municipality' && community.municipality_id) {
            municipalityCommunityById.set(String(community.municipality_id), community);
        }
    });

    const buildCommunityLabel = community => {
        const locationBits = [];
        if (community.barangay_name) {
            locationBits.push(community.barangay_name);
        }
        if (community.municipality_name) {
            locationBits.push(community.municipality_name);
        }
        if (community.province_name) {
            locationBits.push(community.province_name);
        }
        return locationBits.length ? `${community.name} â€¢ ${locationBits.join(', ')}` : community.name;
    };

    const ensureCommunityOption = community => {
        if (!communitiesSelect || !community) {
            return null;
        }
        let option = Array.from(communitiesSelect.options).find(opt => opt.value === String(community.id));
        if (option) {
            option.textContent = option.textContent || buildCommunityLabel(community);
            return option;
        }
        option = document.createElement('option');
        option.value = String(community.id);
        option.textContent = buildCommunityLabel(community);
        option.dataset.regionName = community.region_name || '';
        option.dataset.provinceName = community.province_name || '';
        option.dataset.municipalityName = community.municipality_name || '';
        option.dataset.barangayName = community.barangay_name || '';
        communitiesSelect.appendChild(option);
        return option;
    };

    const setCommunitySelected = (communityId, shouldSelect, community) => {
        if (!communitiesSelect || !communityId) {
            return;
        }
        const details = community || communityById.get(String(communityId));
        if (!details) {
            return;
        }
        const option = ensureCommunityOption(details);
        if (option) {
            option.selected = shouldSelect;
        }
    };

    const communitySelectionCounts = new Map();

    const adjustCommunitySelection = (communityId, delta, community) => {
        if (!communityId || delta === 0) {
            return;
        }
        const current = communitySelectionCounts.get(communityId) || 0;
        const next = current + delta;
        if (next <= 0) {
            communitySelectionCounts.delete(communityId);
            setCommunitySelected(communityId, false, community);
        } else {
            communitySelectionCounts.set(communityId, next);
            setCommunitySelected(communityId, true, community);
        }
    };

    const dispatchCommunityChange = () => {
        if (!communitiesSelect) {
            return;
        }
        communitiesSelect.dispatchEvent(new Event('change', { bubbles: true }));
    };

    const activateCoverageMap = (mapContainer, selectors) => {
        if (!mapContainer || typeof window === 'undefined' || !window.OBCMaps) {
            return;
        }
        const mapAPI = window.OBCMaps;
        if (selectors) {
            mapAPI.initCoverageMap(mapContainer, selectors);
        } else {
            mapAPI.initContainer(mapContainer);
        }
        if (typeof mapAPI.refreshCoverage === 'function') {
            mapAPI.refreshCoverage(mapContainer);
        }
    };

    const setupLocationSelectors = (selects, initial = {}) => {
        const { regionSelect, provinceSelect, municipalitySelect, barangaySelect } = selects;
        if (!regionSelect) {
            return;
        }

        const getPlaceholder = (element, fallback) =>
            element && element.dataset && element.dataset.placeholder ? element.dataset.placeholder : fallback;

        const regionPlaceholder = getPlaceholder(regionSelect, 'Select region...');
        const provincePlaceholder = getPlaceholder(provinceSelect, 'Select province...');
        const municipalityPlaceholder = getPlaceholder(municipalitySelect, 'Select municipality / city...');
        const barangayPlaceholder = getPlaceholder(barangaySelect, 'Select barangay...');

        const regionLabel = region => (region && region.code ? `Region ${region.code} - ${region.name}` : region.name);

        const initialRegion = toStringId(initial.region || (regionSelect.dataset.initial || regionSelect.value));
        const initialProvince = toStringId(initial.province || (provinceSelect && (provinceSelect.dataset.initial || provinceSelect.value)));
        const initialMunicipality = toStringId(initial.municipality || (municipalitySelect && (municipalitySelect.dataset.initial || municipalitySelect.value)));
        const initialBarangay = toStringId(initial.barangay || (barangaySelect && (barangaySelect.dataset.initial || barangaySelect.value)));

        const updateProvinceOptions = (regionId, selectedValue) => {
            const options = regionId ? provincesByRegion.get(toStringId(regionId)) || [] : [];
            setOptions(provinceSelect, options, provincePlaceholder, selectedValue);
        };

        const updateMunicipalityOptions = (provinceId, selectedValue) => {
            const options = provinceId ? municipalitiesByProvince.get(toStringId(provinceId)) || [] : [];
            setOptions(municipalitySelect, options, municipalityPlaceholder, selectedValue);
        };

        const updateBarangayOptions = (municipalityId, selectedValue) => {
            const options = municipalityId ? barangaysByMunicipality.get(toStringId(municipalityId)) || [] : [];
            setOptions(barangaySelect, options, barangayPlaceholder, selectedValue);
        };

        const autoSelectMunicipalityForProvince = (shouldDispatch = true) => {
            if (!provinceSelect || !municipalitySelect) {
                return false;
            }
            const provinceId = toStringId(provinceSelect.value);
            if (!provinceId) {
                return false;
            }
            const targetMunicipalityId = autoMunicipalityByProvince.get(provinceId);
            if (!targetMunicipalityId) {
                return false;
            }
            const hasOption = Array.from(municipalitySelect.options || []).some(
                option => option.value === targetMunicipalityId
            );
            if (!hasOption) {
                return false;
            }
            if (municipalitySelect.value !== targetMunicipalityId) {
                municipalitySelect.value = targetMunicipalityId;
            }
            if (shouldDispatch) {
                municipalitySelect.dispatchEvent(new Event('change'));
            }
            return true;
        };

        setOptions(regionSelect, locationData.regions || [], regionPlaceholder, initialRegion, regionLabel);
        updateProvinceOptions(initialRegion, initialProvince);
        updateMunicipalityOptions(initialProvince, initialMunicipality);
        updateBarangayOptions(initialMunicipality, initialBarangay);

        regionSelect.addEventListener('change', () => {
            updateProvinceOptions(regionSelect.value, '');
            updateMunicipalityOptions('', '');
            updateBarangayOptions('', '');
        });

        if (provinceSelect) {
            provinceSelect.addEventListener('change', () => {
                updateMunicipalityOptions(provinceSelect.value, '');
                const autoHandled = autoSelectMunicipalityForProvince();
                if (!autoHandled) {
                    updateBarangayOptions('', '');
                }
            });
        }

        if (municipalitySelect) {
            municipalitySelect.addEventListener('change', () => {
                updateBarangayOptions(municipalitySelect.value, '');
            });
        }

        if (!initialMunicipality) {
            autoSelectMunicipalityForProvince();
        }
    };

    const updateRowCommunity = (rowState, barangayId, municipalityId) => {
        if (rowState.communityId) {
            adjustCommunitySelection(rowState.communityId, -1);
            rowState.communityId = '';
        }
        if (!barangayId && !municipalityId) {
            return;
        }
        if (barangayId) {
            const community = communityByBarangay.get(String(barangayId));
            if (community) {
                const communityId = String(community.id);
                adjustCommunitySelection(communityId, 1, community);
                rowState.communityId = communityId;
                return;
            }
        }
        if (municipalityId) {
            const municipalityRecord = municipalityCommunityById.get(String(municipalityId));
            if (municipalityRecord) {
                const municipalityKey = String(municipalityRecord.id);
                adjustCommunitySelection(municipalityKey, 1, municipalityRecord);
                rowState.communityId = municipalityKey;
            }
        }
    };

    const bindLocationListeners = (regionSelect, provinceSelect, municipalitySelect, barangaySelect, rowState) => {
        const handleChange = () => {
            updateRowCommunity(rowState, barangaySelect ? barangaySelect.value : '', municipalitySelect ? municipalitySelect.value : '');
            dispatchCommunityChange();
        };

        [regionSelect, provinceSelect, municipalitySelect, barangaySelect]
            .filter(Boolean)
            .forEach(select => {
                select.addEventListener('change', handleChange);
            });

        handleChange();
    };

    const primaryRegion = document.getElementById('id_coverage_region');
    const primaryProvince = document.getElementById('id_coverage_province');
    const primaryMunicipality = document.getElementById('id_coverage_municipality');
    const primaryBarangay = document.getElementById('id_coverage_barangay');
    const primaryMapContainer = document.querySelector('[data-coverage-map="primary"]');

    const initialCommunities = communitiesSelect
        ? Array.from(communitiesSelect.options)
              .filter(option => option.selected)
              .map(option => communityById.get(String(option.value)))
              .filter(Boolean)
        : [];

    if (initialCommunities.length && primaryBarangay && !primaryBarangay.value) {
        const firstCommunity = initialCommunities[0];
        if (firstCommunity) {
            if (primaryRegion && !primaryRegion.value && firstCommunity.region_id) {
                primaryRegion.dataset.initial = firstCommunity.region_id;
            }
            if (primaryProvince && !primaryProvince.value && firstCommunity.province_id) {
                primaryProvince.dataset.initial = firstCommunity.province_id;
            }
            if (primaryMunicipality && !primaryMunicipality.value && firstCommunity.municipality_id) {
                primaryMunicipality.dataset.initial = firstCommunity.municipality_id;
            }
            if (primaryBarangay && !primaryBarangay.value && firstCommunity.barangay_id) {
                primaryBarangay.dataset.initial = firstCommunity.barangay_id;
            }
        }
    }

    setupLocationSelectors({
        regionSelect: primaryRegion,
        provinceSelect: primaryProvince,
        municipalitySelect: primaryMunicipality,
        barangaySelect: primaryBarangay,
    });

    const primaryRowState = { communityId: '' };
    bindLocationListeners(primaryRegion, primaryProvince, primaryMunicipality, primaryBarangay, primaryRowState);
    activateCoverageMap(primaryMapContainer);

    const template = document.getElementById('coverage-row-template');
    const additionalRowsContainer = document.getElementById('additional-coverage-rows');
    const addRowButton = document.getElementById('add-coverage-row');
    const MIN_ROWS = 2;

    const totalRows = () => 1 + additionalRowsContainer.querySelectorAll('[data-coverage-row]').length;

    const enforceRemovalState = () => {
        const removable = totalRows() > MIN_ROWS;
        additionalRowsContainer.querySelectorAll('[data-action="remove-row"]').forEach(button => {
            button.disabled = !removable;
            button.classList.toggle('opacity-50', !removable);
            button.classList.toggle('cursor-not-allowed', !removable);
        });
    };

    const removeCoverageRow = (row, rowState) => {
        if (totalRows() <= MIN_ROWS) {
            return;
        }
        updateRowCommunity(rowState, '');
        row.remove();
        enforceRemovalState();
        dispatchCommunityChange();
    };

    const createCoverageRow = initialCommunity => {
        if (!template || !additionalRowsContainer) {
            return null;
        }
        const fragment = template.content.cloneNode(true);
        const row = fragment.querySelector('[data-coverage-row]');
        const regionSelect = row.querySelector('[data-field="region"]');
        const provinceSelect = row.querySelector('[data-field="province"]');
        const municipalitySelect = row.querySelector('[data-field="municipality"]');
        const barangaySelect = row.querySelector('[data-field="barangay"]');

        const initials = initialCommunity
            ? {
                  region: initialCommunity.region_id,
                  province: initialCommunity.province_id,
                  municipality: initialCommunity.municipality_id,
                  barangay: initialCommunity.barangay_id,
              }
            : {};

        setupLocationSelectors({
            regionSelect,
            provinceSelect,
            municipalitySelect,
            barangaySelect,
        }, initials);

        const rowState = { communityId: '' };
        bindLocationListeners(regionSelect, provinceSelect, municipalitySelect, barangaySelect, rowState);

        const mapContainer = row.querySelector('[data-coverage-map]');

        additionalRowsContainer.appendChild(row);

        activateCoverageMap(mapContainer, {
            regionSelect,
            provinceSelect,
            municipalitySelect,
            barangaySelect,
        });

        if (initialCommunity && initialCommunity.barangay_id) {
            barangaySelect.value = toStringId(initialCommunity.barangay_id);
            barangaySelect.dispatchEvent(new Event('change'));
        } else if (initialCommunity && initialCommunity.municipality_id) {
            municipalitySelect.value = toStringId(initialCommunity.municipality_id);
            municipalitySelect.dispatchEvent(new Event('change'));
        }

        const removeButton = row.querySelector('[data-action="remove-row"]');
        if (removeButton) {
            removeButton.addEventListener('click', () => removeCoverageRow(row, rowState));
        }

        enforceRemovalState();
        return row;
    };

    const extraRowsNeeded = Math.max(1, initialCommunities.length - 1);
    for (let index = 0; index < extraRowsNeeded; index += 1) {
        const community = initialCommunities[index + 1] || null;
        createCoverageRow(community);
    }

    if (addRowButton) {
        addRowButton.addEventListener('click', () => {
            const newRow = createCoverageRow(null);
            if (newRow) {
                const firstSelect = newRow.querySelector('[data-field="region"]');
                if (firstSelect) {
                    firstSelect.focus();
                }
            }
        });
    }

    enforceRemovalState();
    dispatchCommunityChange();

    const saveLocationsButton = document.getElementById('save-obc-locations');
    if (saveLocationsButton) {
        saveLocationsButton.addEventListener('click', () => {
            saveLocationsButton.classList.add('bg-emerald-700');
            setTimeout(() => saveLocationsButton.classList.remove('bg-emerald-700'), 600);
        });
    }

    const formElement = document.querySelector('.obc-form');
    if (formElement && communitiesSelect) {
        formElement.addEventListener('submit', () => {
            Array.from(communitiesSelect.options)
                .filter(option => option.value.startsWith('municipality-'))
                .forEach(option => {
                    option.selected = false;
                });
        });
    }
});
</script>
{% endblock %}
