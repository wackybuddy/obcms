{% extends 'base.html' %}
{% load humanize %}

{% block title %}Manage Provincial OBC - OBC Management System{% endblock %}

{% block breadcrumb %}
<li class="flex items-center space-x-2">
    <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
    <span class="text-gray-900 font-medium">Provincial OBCs</span>
</li>
<li class="flex items-center space-x-2">
    <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
    <span class="text-gray-500 font-medium">Manage Provincial OBC</span>
</li>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-10">
    {% if hero_config %}
    <header class="relative overflow-hidden rounded-3xl bg-bangsamoro-gradient text-white shadow-2xl">
        <div class="absolute inset-0 opacity-20" style="background-image: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.35), transparent 55%), radial-gradient(circle at 80% 0%, rgba(255,255,255,0.25), transparent 60%);"></div>
        <div class="relative flex flex-col lg:flex-row">
            <div class="flex-1 p-8 space-y-6">
                <div class="inline-flex items-center gap-2 bg-white/15 backdrop-blur px-3 py-1 rounded-full text-sm font-semibold uppercase tracking-wide">
                    <i class="{{ hero_config.badge_icon }}"></i>
                    <span>{{ hero_config.badge_text }}</span>
                </div>
                <div class="flex items-start gap-4">
                    <span class="inline-flex h-16 w-16 items-center justify-center rounded-2xl bg-white/15 text-3xl">
                        <i class="{{ hero_config.icon }}"></i>
                    </span>
                    <div>
                        <h1 class="text-3xl font-bold leading-tight">{{ hero_config.title }}</h1>
                        {% if show_archived %}
                        <span class="mt-2 inline-flex items-center gap-2 rounded-full bg-amber-100/90 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-amber-800">Archived view</span>
                        {% endif %}
                        <p class="mt-3 text-white/80 text-lg max-w-2xl">{{ hero_config.subtitle }}</p>
                    </div>
                </div>
                {% if hero_config.level_summary %}
                <p class="text-white/80 text-base max-w-3xl">{{ hero_config.level_summary }}</p>
                {% endif %}
                {% if hero_config.meta_cards %}
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    {% for card in hero_config.meta_cards %}
                    <div class="flex items-start gap-3 rounded-2xl bg-white/12 px-5 py-4 backdrop-blur-sm border border-white/10">
                        {% if card.icon %}
                        <span class="inline-flex h-12 w-12 items-center justify-center rounded-xl bg-white/20 text-xl">
                            <i class="{{ card.icon }}"></i>
                        </span>
                        {% endif %}
                        <div>
                            <p class="text-white/70 text-xs font-semibold uppercase tracking-wide">{{ card.label }}</p>
                            <p class="text-white font-semibold text-sm sm:text-base">{{ card.value }}</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% if hero_config.actions %}
            <div class="lg:w-80 xl:w-96 bg-white/10 border-t border-white/15 lg:border-t-0 lg:border-l rounded-b-3xl lg:rounded-b-none lg:rounded-r-3xl p-6 flex flex-col gap-5 justify-center backdrop-blur">
                <div class="space-y-1">
                    <p class="text-sm font-semibold uppercase tracking-wide text-white/70">Quick actions</p>
                    <p class="text-white/80 text-sm">Coordinate province-level coverage updates.</p>
                </div>
                <div class="flex flex-col gap-3">
                    {% for action in hero_config.actions %}
                    <a href="{{ action.href }}"
                       class="inline-flex items-center justify-center gap-2 rounded-2xl px-5 py-3 font-semibold transition-all duration-200 {% if action.variant == 'primary' %}bg-white text-emerald-600 hover:bg-emerald-50 shadow-lg shadow-emerald-900/25{% elif action.variant == 'secondary' %}bg-white/10 border border-white/30 hover:bg-white/20{% else %}bg-transparent border border-white/20 hover:bg-white/10{% endif %}">
                        {% if action.icon %}<i class="{{ action.icon }}"></i>{% endif %}
                        <span>{{ action.label }}</span>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </header>
    {% endif %}

    {% if stat_cards %}
    <section class="{{ stat_cards_grid_class|default:'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6' }}">
        {% for card in stat_cards %}
        <article class="relative overflow-hidden rounded-2xl bg-gradient-to-br from-[#FEFDFB] to-[#F8F5EE] transition-transform duration-300 hover:-translate-y-1"
                 style="box-shadow: 0 16px 35px rgba(20,85,80,0.12), 0 6px 12px rgba(20,85,80,0.08), inset 0 1px 0 rgba(255,255,255,0.7);">
            <div class="absolute inset-0 pointer-events-none bg-[radial-gradient(circle_at_top,rgba(255,255,255,0.85),transparent_60%)]"></div>
            <div class="relative p-6 flex flex-col h-full gap-5">
                <div class="flex items-start justify-between gap-4">
                    <div>
                        <p class="text-xs font-semibold uppercase tracking-wide text-gray-600">{{ card.title }}</p>
                        <p class="mt-3 text-3xl font-extrabold text-gray-900">{{ card.value|default:0|intcomma }}</p>
                    </div>
                    <span class="inline-flex h-14 w-14 items-center justify-center rounded-2xl bg-white shadow-inner">
                        <i class="{{ card.icon|default:'fas fa-chart-bar' }} text-2xl {{ card.icon_color|default:'text-emerald-600' }}"></i>
                    </span>
                </div>
                {% if card.subtitle or card.description %}
                <p class="text-sm text-gray-600">{{ card.subtitle|default:card.description }}</p>
                {% endif %}
                <div class="flex-grow"></div>
            </div>
        </article>
        {% endfor %}
    </section>
    {% endif %}

    <div class="bg-white rounded-xl shadow-xl border border-gray-200 mb-8 overflow-hidden">
        <div class="bg-gradient-to-r from-gray-700 to-gray-800 px-6 py-4">
            <h2 class="text-xl font-bold text-white flex items-center">
                <i class="fas fa-filter mr-3 text-2xl"></i>
                Filters & Search
            </h2>
        </div>
        <div class="p-6">
            <form method="get"
                  hx-get="{% url 'communities:communities_manage_provincial' %}"
                  hx-target="#provincial-results-container"
                  hx-swap="innerHTML transition:true"
                  hx-trigger="change from:select, submit"
                  hx-indicator="#filter-loading-indicator"
                  class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-12 gap-4">
                <div class="lg:col-span-3">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Region</label>
                    <div class="relative">
                        <select name="region" data-initial="{{ current_region|default:'' }}"
                                class="block w-full appearance-none rounded-xl border border-gray-200 bg-white py-3 pl-4 pr-12 text-base shadow-sm focus:border-emerald-500 focus:ring-emerald-500 min-h-[48px] transition-all duration-200">
                            <option value="">All Regions</option>
                            {% for region in regions %}
                            <option value="{{ region.id }}" {% if current_region == region.id|stringformat:"s" %}selected{% endif %}>{{ region.name }}</option>
                            {% endfor %}
                        </select>
                        <span class="pointer-events-none absolute inset-y-0 right-4 flex items-center text-gray-400">
                            <i class="fas fa-chevron-down text-sm"></i>
                        </span>
                    </div>
                </div>
                <div class="lg:col-span-3">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Province</label>
                    <div class="relative">
                        <select name="province" data-initial="{{ current_province|default:'' }}"
                                class="block w-full appearance-none rounded-xl border border-gray-200 bg-white py-3 pl-4 pr-12 text-base shadow-sm focus:border-emerald-500 focus:ring-emerald-500 min-h-[48px] transition-all duration-200">
                            <option value="">All Provinces</option>
                            {% for province in provinces %}
                            <option value="{{ province.id }}" {% if current_province == province.id|stringformat:"s" %}selected{% endif %}>{{ province.name }}</option>
                            {% endfor %}
                        </select>
                        <span class="pointer-events-none absolute inset-y-0 right-4 flex items-center text-gray-400">
                            <i class="fas fa-chevron-down text-sm"></i>
                        </span>
                    </div>
                </div>
                <div class="lg:col-span-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Search</label>
                    <input type="text" name="search" value="{{ search_query|default:'' }}"
                           placeholder="Search province, region, or key municipalities..."
                           class="block w-full rounded-xl border border-gray-200 bg-white px-4 py-3 text-base shadow-sm focus:border-emerald-500 focus:ring-emerald-500 min-h-[48px] transition-all duration-200 placeholder:text-gray-400">
                </div>
                <div class="lg:col-span-2 flex items-end gap-3">
                    <button type="submit" class="inline-flex w-full items-center justify-center rounded-xl bg-emerald-600 px-6 py-3 font-semibold text-white shadow-sm transition-all duration-200 hover:bg-emerald-700">
                        <span class="htmx-indicator hidden" id="filter-loading-indicator">
                            <i class="fas fa-spinner fa-spin mr-2"></i>
                        </span>
                        <span class="htmx-indicator-shown">Apply</span>
                    </button>
                    <a href="{% url 'communities:communities_manage_provincial' %}" class="inline-flex w-full items-center justify-center rounded-xl border border-emerald-200 bg-white px-6 py-3 font-semibold text-emerald-600 transition-all duration-200 hover:bg-emerald-50">
                        Clear
                    </a>
                </div>
            </form>
        </div>
    </div>

    <div id="provincial-results-container">
        {% include "communities/partials/provincial_manage_results.html" %}
    </div> <!-- Close #provincial-results-container -->
{% endblock %}

{% block extra_js %}
<script id="provincial-province-options" type="application/json">{{ province_options_json|default:"[]"|safe }}</script>
<script>
    (function() {
        console.log('[Provincial OBC] Script loaded');

        function initializeFilters() {
            console.log('[Provincial OBC] Initializing filters...');

            const dataElement = document.getElementById('provincial-province-options');
            if (!dataElement) {
                console.warn('[Provincial OBC] âš ï¸ Province data element not found');
                return;
            }

            let provinceOptions = [];
            try {
                provinceOptions = JSON.parse(dataElement.textContent);
                console.log('[Provincial OBC] âœ… Loaded province options:', provinceOptions.length);
                console.log('[Provincial OBC] First province:', provinceOptions[0]);
            } catch (error) {
                console.error('[Provincial OBC] âŒ Failed to parse province options:', error);
            }

            const regionSelect = document.querySelector('form select[name="region"]');
            const provinceSelect = document.querySelector('form select[name="province"]');
            if (!regionSelect || !provinceSelect) {
                console.warn('[Provincial OBC] âš ï¸ One or more select elements not found');
                console.log('Region:', regionSelect, 'Province:', provinceSelect);
                return;
            }

            const populateProvinces = (regionId, preserveValue) => {
                const normalizedId = regionId ? String(regionId) : '';
                const previousValue = preserveValue ? String(preserveValue) : '';
                const filtered = normalizedId
                    ? provinceOptions.filter((option) => String(option.region_id) === normalizedId)
                    : provinceOptions;

                console.log(`[Provincial OBC] ðŸ”„ Populating provinces for region "${normalizedId}":`, filtered.length, 'provinces found');
                if (filtered.length > 0) {
                    console.log('[Provincial OBC] Sample provinces:', filtered.slice(0, 3).map(p => p.name));
                }

                provinceSelect.innerHTML = '';
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'All Provinces';
                provinceSelect.appendChild(defaultOption);

                filtered.forEach((option) => {
                    const opt = document.createElement('option');
                    opt.value = option.id;
                    opt.textContent = option.name;
                    provinceSelect.appendChild(opt);
                });

                if (previousValue && filtered.some((option) => String(option.id) === previousValue)) {
                    provinceSelect.value = previousValue;
                    console.log('[Provincial OBC] âœ… Restored province selection:', previousValue);
                }

                console.log('[Provincial OBC] Province dropdown now has', provinceSelect.options.length, 'options');
            };

            const initialRegion = regionSelect.dataset.initial || regionSelect.value || '';
            const initialProvince = provinceSelect.dataset.initial || provinceSelect.value || '';

            console.log('[Provincial OBC] ðŸ“Š Initial state:');
            console.log('  Region:', initialRegion, '(from', regionSelect.dataset.initial ? 'data-initial' : 'value', ')');
            console.log('  Province:', initialProvince, '(from', provinceSelect.dataset.initial ? 'data-initial' : 'value', ')');

            populateProvinces(initialRegion, initialProvince);

            regionSelect.addEventListener('change', () => {
                console.log('[Provincial OBC] ðŸ‘‰ Region changed to:', regionSelect.value);
                populateProvinces(regionSelect.value, '');
            });

            console.log('[Provincial OBC] âœ… Initialization complete');
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeFilters);
        } else {
            initializeFilters();
        }
    })();
</script>
{% endblock %}
